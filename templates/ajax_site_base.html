{% extends "site_base.html" %}

{% load i18n %}
{% load account_tags %}
{% load ifsetting_tag %}
{% load activetab_tags %}
{% load cache %}


{% block extra_head_base %}
    {% include "_dojo_minimal_setup.html" %}

    {# tells googlebot to crawl /?_escaped_fragment_= #}
    <meta name="fragment" content="!">

    <link rel="stylesheet" href="{{ MEDIA_URL }}static/js/jdic/jPlayer/skins/manabi/jplayer.css"></link>


    <script type="text/javascript" src="{{ MEDIA_URL }}static/js/highcharts/highcharts.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}static/js/jquery-sparkline/jquery.sparkline.js" charset="utf-8"></script>

    <script type="text/javascript">
        $(function() {
            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });
        });

		dojo.ready(function(){
            manabi_ui.hideLoader();
		});
    </script>

    <script type="text/javascript" src="{{ MEDIA_URL }}static/js/jdic/jPlayer/jquery.jplayer.min.js"></script>

    {% block extra_head %}{% endblock %}

    {% if user.is_authenticated %}
        <style type="text/css">
            @import url({{ STATIC_URL }}flashcards/css/tundraGridMod.css);
            @import url({{ DOJANGO.DOJOX_URL }}/widget/Dialog/Dialog.css);
            .dojoxGrid table { margin: 0; }
        </style>

        <script type="text/javascript">
            dojo.require('reviews');
            dojo.require('reviews_ui');
            dojo.require('jdic.audio');
            dojo.require('kanjivg.frames');
            dojo.require('reviews.CardStatsButton');
            //dojo.require('reviews.CardPreview');
            dojo.require('stats.UsageSparkline');


            // Fact editor grid
            //
            //TODO: This is really old code that needs to be cleaned up.
            //
            //defaultCell: { width: 8, editable: false, type: dojox.grid.cells._Widget },
            var cards_editRow = function(row_index) {
                var selected_fact_id = cards_factsGrid.getItem(row_index)['fact-id'];
                var success_callback = dojo.hitch(null, function(selected_fact_row_index, data, card_counter) {
                    fact_ui.hideFactEditForm();
                    //update the grid item via the grid's store, to update the display (though the change has already gone to the server)
                    var grid_item = cards_factsGrid.getItem(selected_fact_row_index);
                    dojo.query('.cards_fieldContent', cards_factForm.domNode).forEach(function(field_content_item) {
                        var field_content_type_item = dijit.getEnclosingWidget(field_content_item.nextElementSibling);
                        var field_content_item = dijit.getEnclosingWidget(field_content_item);
                        var new_value = '';
                        if (field_content_item.get('baseClass') == 'dijitSelect') {
                            new_value = field_content_item.get('displayedValue');
                            if (field_content_item.get('value') == 'none') {
                                new_value = '';
                            }
                        } else {
                            new_value = field_content_item.get('value');
                        }
                        cards_factsGrid.store.setValue(grid_item, 
                            'id' + field_content_type_item.get('value'), 
                            new_value);
                    });
                    cards_factsGrid.store.save(); //TODO handle errors
                }, row_index);
            
                fact_ui.showFactEditForm(selected_fact_id, success_callback);
            }

            dojo.declare("dojox.grid.formatterScopeObj", null, {
		        store: null,
		        _widgets: [],
		        constructor: function(kwArgs){
			        this.store = kwArgs.store;
			        this._widgets = [];
		        },
                cards_formatCardActions: function(item, row_index) {
                    return '<span class="fakeLink" onclick="cards_editRow('+row_index+')">Edit</span>';
            }});

            fact_ui.current_search_url_parameter = '';
            fact_ui.current_tag_filter_list = Array();


            dojo.addOnLoad(function() {
                fact_add_ui.setKeyboardShortcuts();
            });
        </script>

    {% endif %}


{% endblock %}

{% block body_top %}
    <div id="siteLoader"><div id="siteLoaderInner"></div></div> 
{% endblock %}

{% block login %}
    {% load i18n ifsetting_tag account_tags %}
    {% load lazysignup_tags %}

    {% if user|is_lazy_user %}
            <a href="{% url acct_login %}">{% trans "Login" %}</a> {% ifsetting ACCOUNT_OPEN_SIGNUP %}{% trans "or" %} <a href="{% url lazysignup_convert %}"><b>{% trans "Sign up" %}</b></a>{% endifsetting %}
    {% else %}
        {% if user.is_authenticated %}
            <b>{% user_display user %}</b> | <a href="{% url acct_email %}">{% trans "Account" %}</a> | {% if user.is_staff %}<a href="/admin/">{% trans "Admin" %}</a> | {% endif %}<a href="{% url acct_logout %}">{% trans "Logout" %}</a>
        {% else %}
            <a href="{% url acct_login %}">{% trans "Login" %}</a> {% ifsetting ACCOUNT_OPEN_SIGNUP %}{% trans "or" %} <a href="{% url acct_signup %}"><b>{% trans "Sign up" %}</b></a>{% endifsetting %}
        {% endif %}
    {% endif %}
{% endblock %}

{% block site_title_link_tag %}
    <a href="{% url home_inline %}" class="xhr_link">
{% endblock %}

{% block nav %}
    <ul>
        <li id="nav_tab_home" class="tab {% is_active_tab request "home" %}"><a href="{% url home_inline %}" id="nav_home_link" class="xhr_link">Home</a>
        {% if user.is_authenticated %}
            <li id="nav_tab_add" class="tab {% is_active_tab request "add" %}"><a href="{% url add_decks %}" id="nav_add_link" class="xhr_link">Add</a>
            <li id="nav_tab_manage" class="tab {% is_active_tab request "manage" %}"><a href="{% url decks %}" id="nav_manage_link" class="xhr_link">Manage</a>
            <li id="nav_tab_stats" class="tab {% is_active_tab request "stats" %}"><a href="{% url stats %}" class="xhr_link">Stats</a>
        {% endif %}

        <script type="text/javascript">
            dojo.subscribe('manabi.tab_activated', function(tab_name) {
                // make all tabs inactive first
                dojo.query('#nav .tab').removeClass('active');
                
                // Make the appropriate tab active
                dojo.query('#nav_tab_' + tab_name).addClass('active');
            });
        </script>
    </ul>
{% endblock %}

{% block above_body_contents %}
    {% if user.is_authenticated %}
        {% with user|is_lazy_user as user_is_lazy %}
            {% cache 1200 flashcards_base_html user_is_lazy %}
            {% include "flashcards/base.html" %}
            {% endcache %}
        {% endwith %}
    {% endif %}
    <div jsId="manabi_standby" target="body_contents" dojoType="dojox.widget.Standby"></div>
{% endblock %}

{% block body %}
    <div dojoType="dojox.layout.ContentPane" jsId="body_pane" style="overflow:hidden" executeScripts="true" scriptHasHooks="true">
        <script type="dojo/method" event="onDownloadStart">
            /*var bodyNode = dojo.byId('body_contents');
            var pos = dojo.position(bodyNode, true);

            dojo.style(loader, {
                left: pos.x + 'px',
                top: pos.y + 'px',
                height: 200,//pos.h,
                width: pos.w,
	            background: 'white',
	            opacity: 1 
            });*/
            dojo.query('.legal').style({ display: 'none' });

            return '<div class="bodyPaneLoader"><div class="bodyPaneLoaderInner"></div></div>';
        </script>
        <script type="dojo/connect" event="onDownloadEnd">
            dojo.query('.legal').style({ display: '' });
            manabi_ui.convertLinksToXhr(body_pane.domNode);            
            //manabi_ui.hideLoader();
        </script>
        {% block body_contents %}
        {% endblock %}
    </div>
{% endblock %}


