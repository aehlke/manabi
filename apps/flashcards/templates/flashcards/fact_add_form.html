{% comment %}Update this to use the standard fact_form.html, need to update the js to use the new names mostly{% endcomment %}

<div dojoType="dojo.data.ItemFileReadStore" jsId="decksStore" 
    url="/flashcards/rest/decks" clearOnClose="true">
</div>


<div id="factAddFormWrapper">
    <div dojoType="dijit.form.Form" jsId="factAddForm" encType="multipart/form-data" action="" method="" style="margin-bottom:0em">
        <span id="deckInputContainer" style="display:none">
        <input name="fact-deck" jsId="deckInput" 
            dojoType="dijit.form.Select" tabIndex="49">
        </span>
        {% comment %}
        <div> <strong>Deck:</strong> <span id="deckInputContainer"> <input name="fact-deck" jsId="deckInput" dojoType="dijit.form.Select" tabIndex="49"> </span> </div>
        {% endcomment %}
        <div id="factFields">
            {% for field_type in fact_add_form.field_types %}
                {% if not field_type.disabled_in_form %}
                <div style="margin-top:4px;margin-bottom:4px;">
                    {% if field_type.hidden_in_form and not field_type.disabled_in_form %}
                        <span class="fakeLink hiddenFieldLink" onClick="this.style.display='none';var c=dojo.byId('field_content_container_{{ forloop.counter0 }}');c.style.display='';var d=dijit.getEnclosingWidget(dojo.query('textarea',c)[0]);d.resize();d.focus();">Add {{ field_type.name }}</span>
                    {% endif %}
                    <div id="field_content_container_{{ forloop.counter0 }}"{% if field_type.hidden_in_form %} class="hidden_in_form"{% endif %}>
                        {% if field_type.is_transliteration_field_type %}
                        <span{% comment %} style="float:left;clear:left;display:block;line-height:33px;"{% endcomment %}><strong><label>{{ field_type.name }}:</label></strong>{% if not field_type.blank %} <span style="font-size:80%; color:gray">(required)</span>{% endif %}
                            {% spaceless %}
                                <span class="fakeLink" onclick="fact_ui.generateReading(dijit.byId('id_field_content-0-content').attr('value'),'id_field_content-1-content')">
                                    <img src="{{ MEDIA_URL }}static/css/dojo_themes/tundra/images/icons/arrow_refresh.png">
                                </span>
                                {% endspaceless %}
                        </span>
                        {% else %}
                        <strong><label>{{ field_type.name }}:</label></strong>{% if not field_type.blank %} <span style="font-size:80%; color:gray">(required)</span>{% endif %}
                        {% endif %}
                        {% if field_type.choices %}
                            <select id="id_field_content-{{ forloop.counter0 }}-content" 
                                name="field_content-{{ forloop.counter0 }}-content"
                                dojoType="dijit.form.Select"
                                tabIndex="5{{ forloop.counter }}">
                                <option value="none" selected="selected">
                                     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                </option>
                                {% for choice_value, choice_name in field_type.choices_as_tuple %}
                                    <option value="{{ choice_value }}">
                                        {{ choice_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <div id="id_field_content-{{ forloop.counter0 }}-content-errors" class="field_content_error"{% if field_type.is_transliteration_field_type %} style="display:inline"{% endif %}></div>
                            <div style="overflow:hidden;">
                            {% if field_type.multi_line %}
                                <textarea dojoType="dijit.form.Textarea" 
                            {% else %}
                                <input dojoType="dijit.form.TextBox" 
                            {% endif %}
                                    id="id_field_content-{{ forloop.counter0 }}-content" 
                                    name="field_content-{{ forloop.counter0 }}-content" 
                                    style="width:99%;margin-bottom:3px;" 
                                    class="field_content{% if field_type.transliteration_field_type %} kanji_field{% endif %}{% if field_type.fieldtype %} reading_field{% endif %}"
                                    tabIndex="{% if field_type.is_transliteration_field_type %}-1{% else %}3{{ forloop.counter }}{% endif %}">{% if field_type.multi_line %}</textarea>{% endif %}
                            {% if field_type.transliteration_field_type %}
                                <script type="text/javascript">
                                    //this field has a corresponding transliteration field
                                    dojo.addOnLoad(function() {
                                        var field_widget = dijit.byId('id_field_content-{{ forloop.counter0 }}-content');
                                        dojo.connect(field_widget, 'onBlur', function() {
                                            //automatically generate this kanji field's reading
                                            //TODO unless the newly focused field is the reading field (how to detect new focus?)
                                            var reading_field_node = dojo.query('.reading_field', dojo.byId('factFields'))[0];
                                            if (reading_field_node) {
                                                fact_ui.generateReading(
                                                    this.attr('value'),
                                                    dijit.getEnclosingWidget(reading_field_node));
                                            }
                                        });
                                    });
                                </script>
                            {% else %}
                            {% endif %}
                            </div>
                        {% endif %}
                        <input dojoType="dijit.form.TextBox" 
                            name="field_content-{{ forloop.counter0 }}-field_type" 
                            id="id_field_content-{{ forloop.counter0 }}-field_type" 
                            value="{{ field_type.id }}" 
                            type="hidden">
                    </div>
                </div>
                {% endif %}
            {% endfor %}

        </div>

        <br>
        <div>
            <div id="fact-tag-errors" class="field_content_error"></div>
            <strong>Tags:</strong> 
            <input type="text" name="fact-tags" dojoType="dijit.form.TextBox" 
            id="cardTagsInput" style="width:362px" tabIndex="58">
        </div>
        <div style="margin-top:7px;margin-bottom:7px;">
            <strong style="vertical-align:top">Cards:</strong>
            {% comment %}<select multiple="true" dojoType="dojox.form.CheckedMultiSelect" 
                jsId="cardTemplatesInput" style="height:6.2em;">
                </select>
                {% endcomment %}
            <div style="margin-top:.2em; margin-below:.2em;">
                {% for card_template in fact_add_form.card_templates %}
                    <input name="card_template-{{ card_template.id }}" id="id_card_template-{{ card_template.id }}" dojoType="dijit.form.CheckBox" value="{{ card_template.id }}"{% if card_template.generate_by_default %} checked{% endif %}>
                    <label for="id_card_template-{{ card_template.id }}">{{ card_template.name }}</label>
                {% endfor %}
            </div>
        </div>
        <div style="margin-top:1em;">
            <span>
                <button dojoType="dijit.form.Button" type="submit" 
                    jsId="factAddFormSubmitButton" tabIndex="59" iconClass="manabi_icon manabi_icon_disk">
                    Create Flashcards
                    </button> <button dojoType="dijit.form.Button">
                    Close
                    <script type="dojo/connect" event="onClick" args="evt">
                        factAddDialog.hide();
                    </script>
                </button>
            </span>
        </div>
        <div jsId="factAddFormResults" dojoType="dijit.layout.ContentPane"></div>
    </div>
</div>
